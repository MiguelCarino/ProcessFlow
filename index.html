<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moe Flow Maker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* Smooth Transitions */
        .moe-card { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s; }
        .moe-card:hover { transform: translateY(-2px); }
        
        /* Dropdown Animation */
        .dropdown-enter { animation: popIn 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: top right; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95) translateY(-5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const TEMPLATES = {
          // =====================
          // Remote Support
          // =====================
          rustdesk: [
            { id: 1, title: "Download RustDesk", substeps: [
              "Go to https://rustdesk.com",
              "Click 'Download'",
              "Choose your operating system"
            ]},
            { id: 2, title: "Install RustDesk", substeps: [
              "Open the downloaded file",
              "Accept the license agreement",
              "Complete the installation"
            ]},
            { id: 3, title: "Share Connection ID", substeps: [
              "Open RustDesk",
              "Copy the ID shown on the left",
              "Send the ID to your technician"
            ]},
            { id: 4, title: "Approve Connection", substeps: [
              "Wait for the connection request",
              "Click 'Accept'",
              "Do not close RustDesk during the session"
            ]}
          ],
                
          anydesk: [
            { id: 1, title: "Download AnyDesk", substeps: [
              "Go to https://anydesk.com",
              "Click 'Download Now'"
            ]},
            { id: 2, title: "Run AnyDesk", substeps: [
              "Open the downloaded file",
              "No installation required (optional)"
            ]},
            { id: 3, title: "Share Address", substeps: [
              "Copy 'This Desk' address",
              "Send it to IT support"
            ]}
          ],
                
          // =====================
          // Browser Issues
          // =====================
          chrome_cache: [
            { id: 1, title: "Open Chrome Settings", substeps: [
              "Click the 3 dots (top right)",
              "Select 'Settings'"
            ]},
            { id: 2, title: "Open Clear Browsing Data", substeps: [
              "Go to 'Privacy and security'",
              "Click 'Delete browsing data'"
            ]},
            { id: 3, title: "Clear Cache", substeps: [
              "Time range: All time",
              "Check 'Cached images and files'",
              "Click 'Delete data'"
            ]}
          ],
                
          firefox_cache: [
            { id: 1, title: "Open Firefox Settings", substeps: [
              "Click the 3 lines (top right)",
              "Select 'Settings'"
            ]},
            { id: 2, title: "Clear Data", substeps: [
              "Go to 'Privacy & Security'",
              "Click 'Clear Data'"
            ]},
            { id: 3, title: "Confirm", substeps: [
              "Check 'Cached Web Content'",
              "Click 'Clear'"
            ]}
          ],
                
          // =====================
          // Network / Connectivity
          // =====================
          restart_router: [
            { id: 1, title: "Locate Router", substeps: [
              "Find the modem/router device",
              "Ensure it is powered on"
            ]},
            { id: 2, title: "Power Cycle", substeps: [
              "Unplug the power cable",
              "Wait 30 seconds",
              "Plug the power back in"
            ]},
            { id: 3, title: "Wait for Connection", substeps: [
              "Wait 2‚Äì3 minutes",
              "Check internet connection again"
            ]}
          ],
                
          flush_dns_windows: [
            { id: 1, title: "Open Command Prompt", substeps: [
              "Press Windows + R",
              "Type cmd",
              "Press Enter"
            ]},
            { id: 2, title: "Flush DNS Cache", substeps: [
              "Type: ipconfig /flushdns",
              "Press Enter",
              "Wait for confirmation message"
            ]}
          ],
                
          // =====================
          // Operating System
          // =====================
          windows_update: [
            { id: 1, title: "Open Windows Update", substeps: [
              "Click Start",
              "Go to Settings ‚Üí Windows Update"
            ]},
            { id: 2, title: "Check for Updates", substeps: [
              "Click 'Check for updates'",
              "Wait for scan to complete"
            ]},
            { id: 3, title: "Install & Restart", substeps: [
              "Install available updates",
              "Restart if prompted"
            ]}
          ],
                
          macos_update: [
            { id: 1, title: "Open System Settings", substeps: [
              "Click Apple menu",
              "Open 'System Settings'"
            ]},
            { id: 2, title: "Software Update", substeps: [
              "Go to 'General'",
              "Click 'Software Update'"
            ]},
            { id: 3, title: "Install Updates", substeps: [
              "Click 'Update Now'",
              "Restart if required"
            ]}
          ],
                
          // =====================
          // Security / Access
          // =====================
          password_reset: [
            { id: 1, title: "Open Password Reset Page", substeps: [
              "Go to the company password portal",
              "Click 'Forgot password'"
            ]},
            { id: 2, title: "Verify Identity", substeps: [
              "Enter your email or username",
              "Complete verification steps"
            ]},
            { id: 3, title: "Create New Password", substeps: [
              "Choose a strong password",
              "Confirm the new password",
              "Save changes"
            ]}
          ],
                
          mfa_setup: [
            { id: 1, title: "Install Authenticator App", substeps: [
              "Open App Store or Play Store",
              "Install Microsoft Authenticator or Google Authenticator"
            ]},
            { id: 2, title: "Scan QR Code", substeps: [
              "Open the authenticator app",
              "Scan the QR code provided by IT"
            ]},
            { id: 3, title: "Verify MFA", substeps: [
              "Enter the 6-digit code",
              "Confirm setup"
            ]}
          ],
                
          // =====================
          // Diagnostics / IT Review
          // =====================
          basic_it_review: [
            { id: 1, title: "Check System Status", substeps: [
              "Confirm device powers on",
              "Check for error messages"
            ]},
            { id: 2, title: "Check Connectivity", substeps: [
              "Verify Wi-Fi or Ethernet connection",
              "Test access to internal systems"
            ]},
            { id: 3, title: "Check Updates", substeps: [
              "Verify OS is up to date",
              "Check application versions"
            ]},
            { id: 4, title: "Collect Information", substeps: [
              "Note error messages",
              "Take screenshots if possible",
              "Provide details to IT"
            ]}
          ]
        };


        const THEMES = {
            black: {
                id: 'black', label: 'Dark', bg: 'bg-gray-900', title: 'text-gray-100',
                card: 'bg-gray-800 border border-gray-600 shadow-lg', cardText: 'text-gray-200',
                input: 'text-white placeholder-gray-500', subTag: 'bg-gray-700 text-gray-300',
                arrow: 'border-t-gray-500', linkColor: 'text-blue-400', exportBg: '#111827',
                btnPrimary: 'bg-gray-700 text-white hover:bg-gray-600',
                btnSecondary: 'text-gray-400 hover:text-white bg-transparent'
            },
            white: {
                id: 'white', label: 'Light', bg: 'bg-gray-50', title: 'text-gray-800',
                card: 'bg-white border border-gray-200 shadow-md', cardText: 'text-gray-700',
                input: 'text-gray-800 placeholder-gray-400', subTag: 'bg-gray-100 text-gray-600',
                arrow: 'border-t-gray-300', linkColor: 'text-blue-600', exportBg: '#f9fafb',
                btnPrimary: 'bg-blue-600 text-white hover:bg-blue-700',
                btnSecondary: 'text-gray-500 hover:text-gray-900 bg-transparent'
            },
            blue: {
                id: 'blue', label: 'Blue', bg: 'bg-slate-100', title: 'text-slate-700',
                card: 'bg-white border-t-4 border-t-blue-500 shadow-sm', cardText: 'text-slate-700',
                input: 'text-slate-700 placeholder-slate-400', subTag: 'bg-slate-50 text-slate-600',
                arrow: 'border-t-slate-300', linkColor: 'text-blue-600', exportBg: '#f1f5f9',
                btnPrimary: 'bg-blue-500 text-white hover:bg-blue-600',
                btnSecondary: 'text-slate-500 hover:text-blue-600 bg-transparent'
            },
            cyberpunk: {
                id: 'cyberpunk', label: 'Cyber', bg: 'bg-black', title: 'text-green-400',
                card: 'bg-gray-900 border border-green-500/50 shadow-[0_0_15px_rgba(74,222,128,0.1)]', 
                cardText: 'text-green-400', input: 'text-green-400 placeholder-green-900 font-mono', 
                subTag: 'bg-green-900/20 text-green-400 border border-green-500/30',
                arrow: 'border-t-green-800', linkColor: 'text-cyan-400', exportBg: '#000000',
                btnPrimary: 'bg-green-900/50 text-green-400 border border-green-500 hover:bg-green-500 hover:text-black',
                btnSecondary: 'text-green-600 hover:text-green-400 bg-transparent'
            }
        };

        const FONT_SIZES = {
            small: { label: 'Small', class: 'text-sm' },
            medium: { label: 'Medium', class: 'text-base' },
            large: { label: 'Large', class: 'text-lg' },
            xl: { label: 'Huge', class: 'text-xl' }
        };

        const initialConfig = { showTheme: true, showTemplates: true, showSave: true, showShare: true, showFont: true };
        const initialData = [ { id: 1, title: "First Step", substeps: ["Add details here..."] } ];

        // --- COMPONENT: Editable Text ---
        const EditableText = ({ value, onChange, placeholder, className, linkClass, isMainTitle }) => {
            const [isEditing, setIsEditing] = useState(false);
            const urlRegex = /(https?:\/\/[^\s]+)/g;

            if (isEditing) {
                return (
                    <input autoFocus className={`w-full bg-transparent outline-none border-b border-current opacity-70 ${className}`}
                        value={value} onChange={onChange} onBlur={() => setIsEditing(false)} placeholder={placeholder} />
                );
            }
            return (
                <div onClick={() => setIsEditing(true)} 
                    className={`cursor-text break-all transition ${className} ${!value ? 'opacity-30 italic' : ''}`}>
                    {value ? value.split(urlRegex).map((part, i) => part.match(urlRegex) ? 
                        <a key={i} href={part} target="_blank" className={`${linkClass} hover:underline relative z-10`} onClick={e => e.stopPropagation()}>{part}</a> 
                        : part) : placeholder}
                </div>
            );
        };

        function App() {
            const [mainTitle, setMainTitle] = useState("");
            const [steps, setSteps] = useState(initialData);
            const [config, setConfig] = useState(initialConfig);
            const [currentTheme, setCurrentTheme] = useState('black');
            const [currentFont, setCurrentFont] = useState('large');
            
            const [menuState, setMenuState] = useState({ theme: false, templates: false, settings: false, save: false, font: false });
            const [isLoaded, setIsLoaded] = useState(false);
            const flowRef = useRef(null);

            // 1. Load State
            useEffect(() => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decoded = JSON.parse(decodeURIComponent(escape(window.atob(hash))));
                        if (decoded.mainTitle) setMainTitle(decoded.mainTitle);
                        if (decoded.steps) setSteps(decoded.steps);
                        if (decoded.theme) setCurrentTheme(decoded.theme);
                        if (decoded.font) setCurrentFont(decoded.font);
                        if (decoded.config) setConfig(decoded.config);
                    } catch (e) { console.error(e); }
                }
                setIsLoaded(true);
            }, []);

            // 2. Save State
            useEffect(() => {
                if (!isLoaded) return;
                const payload = { mainTitle, steps, theme: currentTheme, font: currentFont, config };
                const encoded = window.btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
                window.history.replaceState(null, null, '#' + encoded);
            }, [mainTitle, steps, currentTheme, currentFont, config, isLoaded]);

            const t = THEMES[currentTheme];

            // Actions
            const toggleMenu = (key) => setMenuState(prev => ({ theme: false, templates: false, settings: false, save: false, font: false, [key]: !prev[key] }));
            const loadTemplate = (key) => { if(confirm("Replace current steps?")) { setSteps(TEMPLATES[key]); setMenuState({}); }};
            const updateConfig = (key) => setConfig(prev => ({...prev, [key]: !prev[key]}));
            
            // CRUD
            const addMainStep = () => setSteps([...steps, { id: Date.now(), title: "", substeps: [] }]);
            const updateStep = (id, field, val) => setSteps(steps.map(s => s.id === id ? { ...s, [field]: val } : s));
            const addSub = (id) => setSteps(steps.map(s => s.id === id ? { ...s, substeps: [...s.substeps, ""] } : s));
            const updateSub = (sId, idx, val) => setSteps(steps.map(s => s.id !== sId ? s : { ...s, substeps: s.substeps.map((sub, i) => i === idx ? val : sub) }));
            const delSub = (sId, idx) => setSteps(steps.map(s => s.id !== sId ? s : { ...s, substeps: s.substeps.filter((_, i) => i !== idx) }));
            const delStep = (id) => { if(steps.length > 1) setSteps(steps.filter(s => s.id !== id)); };

            // Export Logic
            const handleExport = (type) => {
                setMenuState({}); 
                if (type === 'json') {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ mainTitle, steps }, null, 2));
                    const link = document.createElement('a'); link.href = dataStr; link.download = "process.json"; link.click();
                } else if (type === 'text') {
                    let textOutput = mainTitle ? `# ${mainTitle}\n\n` : "";
                    steps.forEach((s, i) => { textOutput += `${i + 1}. ${s.title}\n`; s.substeps.forEach(sub => textOutput += `   - ${sub}\n`); textOutput += `\n`; });
                    navigator.clipboard.writeText(textOutput); alert("üí¨ Copied to clipboard!");
                } else {
                    if(!flowRef.current) return;
                    html2canvas(flowRef.current, { backgroundColor: t.exportBg, scale: 2 }).then(canvas => {
                        const link = document.createElement('a'); link.download = `flow.${type}`; link.href = canvas.toDataURL(`image/${type}`); link.click();
                    });
                }
            };

            return (
                <div className={`min-h-screen w-full transition-colors duration-500 ${t.bg} font-['M_PLUS_Rounded_1c']`}>
                    
                    {/* --- NAVBAR --- */}
                    <div className="fixed top-0 w-full p-4 flex justify-between items-center z-50 bg-opacity-90 backdrop-blur-sm pointer-events-none">
                        <a href="https://carino.systems" target="_blank" className={`pointer-events-auto text-xl font-bold tracking-tight hover:opacity-70 transition ${t.title}`}>
                            ProcessFlow
                        </a>

                        <div className="pointer-events-auto flex items-center gap-2">
                            {config.showTemplates && <div className="relative">
                                <button onClick={() => toggleMenu('templates')} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition ${t.btnSecondary}`}>üìÇ Templates</button>
                                {menuState.templates && <div className={`absolute right-0 mt-2 w-48 p-2 rounded-xl z-20 dropdown-enter border ${t.card}`}>
                                    {Object.keys(TEMPLATES).map(k => <button key={k} onClick={() => loadTemplate(k)} className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold opacity-70 hover:opacity-100 ${t.cardText}`}>{TEMPLATES[k][0].title}</button>)}
                                </div>}
                            </div>}

                            {config.showFont && <div className="relative">
                                <button onClick={() => toggleMenu('font')} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition ${t.btnSecondary}`}>Aa</button>
                                {menuState.font && <div className={`absolute right-0 mt-2 w-32 p-2 rounded-xl z-20 dropdown-enter border ${t.card}`}>
                                    {Object.keys(FONT_SIZES).map(k => <button key={k} onClick={() => { setCurrentFont(k); setMenuState({}); }} className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold mb-1 ${currentFont === k ? 'bg-current/10' : 'opacity-60 hover:opacity-100'} ${t.cardText}`}>{FONT_SIZES[k].label}</button>)}
                                </div>}
                            </div>}

                            {config.showTheme && <div className="relative">
                                <button onClick={() => toggleMenu('theme')} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition ${t.btnSecondary}`}>üé® Theme</button>
                                {menuState.theme && <div className={`absolute right-0 mt-2 w-32 p-2 rounded-xl z-20 dropdown-enter border ${t.card}`}>
                                    {Object.values(THEMES).map(th => <button key={th.id} onClick={() => { setCurrentTheme(th.id); setMenuState({}); }} className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold mb-1 ${th.id === currentTheme ? 'bg-current/10' : 'opacity-60 hover:opacity-100'} ${t.cardText}`}>{th.label}</button>)}
                                </div>}
                            </div>}

                            {config.showShare && <button onClick={() => { navigator.clipboard.writeText(window.location.href); alert("Copied!"); }} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition ${t.btnSecondary}`}>Share</button>}

                            {config.showSave && <div className="relative">
                                <button onClick={() => toggleMenu('save')} className={`px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm transition ${t.btnPrimary}`}>Save ‚ñº</button>
                                {menuState.save && <div className={`absolute right-0 mt-2 w-40 p-2 rounded-xl z-20 dropdown-enter border ${t.card}`}>
                                    <div className={`text-[10px] font-bold opacity-40 px-3 py-1 ${t.cardText}`}>IMAGE</div>
                                    {['png', 'webp', 'jpeg'].map(f => <button key={f} onClick={() => handleExport(f)} className={`w-full text-left px-3 py-1.5 rounded-lg text-xs font-bold opacity-70 hover:opacity-100 uppercase ${t.cardText}`}>üñºÔ∏è {f}</button>)}
                                    <div className="h-px bg-current opacity-10 my-1"></div>
                                    <div className={`text-[10px] font-bold opacity-40 px-3 py-1 ${t.cardText}`}>DATA</div>
                                    <button onClick={() => handleExport('json')} className={`w-full text-left px-3 py-1.5 rounded-lg text-xs font-bold opacity-70 hover:opacity-100 ${t.cardText}`}>üìÑ JSON</button>
                                    <button onClick={() => handleExport('text')} className={`w-full text-left px-3 py-1.5 rounded-lg text-xs font-bold opacity-70 hover:opacity-100 ${t.cardText}`}>üí¨ Copy Text</button>
                                </div>}
                            </div>}

                            <div className="relative border-l border-gray-400/30 pl-2 ml-1">
                                <button onClick={() => toggleMenu('settings')} className={`p-1.5 rounded-full opacity-50 hover:opacity-100 transition ${t.cardText}`}>‚öôÔ∏è</button>
                                {menuState.settings && <div className={`absolute right-0 mt-2 w-48 p-3 rounded-xl z-20 dropdown-enter border ${t.card}`}>
                                    <div className={`text-xs font-bold mb-2 opacity-50 ${t.cardText}`}>CONTROLS</div>
                                    {['showTemplates', 'showTheme', 'showFont', 'showSave', 'showShare'].map(k => <label key={k} className={`flex items-center justify-between text-xs font-bold mb-2 cursor-pointer ${t.cardText}`}>{k.replace('show', '')} <input type="checkbox" checked={config[k]} onChange={() => updateConfig(k)} className="accent-blue-500"/></label>)}
                                </div>}
                            </div>
                        </div>
                    </div>

                    {/* --- CANVAS --- */}
                    <div className={`pt-24 pb-20 px-4 min-h-screen flex justify-center overflow-auto ${FONT_SIZES[currentFont].class}`}>
                        <div ref={flowRef} className={`p-8 rounded-3xl ${t.bg === 'bg-black' ? 'bg-black' : 'bg-transparent'} flex flex-col items-center max-w-2xl w-full`}>
                            
                            {/* MAIN TITLE (Invisible in Export if Empty) */}
                            <div className={`w-full mb-8 text-center`} data-html2canvas-ignore={!mainTitle ? "true" : undefined}>
                                <div className={`text-[2em] font-bold ${t.title}`}>
                                    <EditableText 
                                        value={mainTitle} 
                                        onChange={(e) => setMainTitle(e.target.value)} 
                                        placeholder="Process Title..." 
                                        className="text-center font-bold tracking-tight"
                                        linkClass={t.linkColor}
                                    />
                                </div>
                            </div>

                            {steps.map((step, index) => (
                                <React.Fragment key={step.id}>
                                    {index > 0 && <div className={`w-0 h-0 border-x-[0.6em] border-x-transparent border-t-[0.8em] ${t.arrow} my-1 opacity-50`}></div>}

                                    <div className={`relative w-full rounded-xl p-5 group moe-card ${t.card}`}>
                                        <button onClick={() => delStep(step.id)} data-html2canvas-ignore="true" className="absolute -top-2 -right-2 w-6 h-6 flex items-center justify-center bg-red-400 text-white rounded-full opacity-0 group-hover:opacity-100 transition shadow-sm text-xs z-20">√ó</button>

                                        <div className={`font-bold text-center mb-4 text-[1.25em] ${t.title}`}>
                                            <EditableText value={step.title} onChange={(e) => updateStep(step.id, 'title', e.target.value)} placeholder="Step Name" className="text-center" linkClass={t.linkColor}/>
                                        </div>

                                        <div className="space-y-2">
                                            {step.substeps.map((sub, idx) => (
                                                <div key={idx} className={`group/sub flex items-start gap-3 rounded px-2 py-1 transition hover:bg-black/5`}>
                                                    <div className={`mt-[0.6em] w-[0.4em] h-[0.4em] rounded-full ${t.id === 'cyberpunk' ? 'bg-green-500' : 'bg-current'} opacity-40 shrink-0`}></div>
                                                    <div className={`flex-1 ${t.id === 'black' ? 'font-light' : ''} ${t.cardText}`}>
                                                        <EditableText value={sub} onChange={(e) => updateSub(step.id, idx, e.target.value)} placeholder="..." linkClass={t.linkColor}/>
                                                    </div>
                                                    <button onClick={() => delSub(step.id, idx)} data-html2canvas-ignore="true" className="text-red-400 opacity-0 group-hover/sub:opacity-100 text-xs px-1">√ó</button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="mt-2 flex justify-center h-6 items-center">
                                            <button onClick={() => addSub(step.id)} data-html2canvas-ignore="true" className={`text-[0.7em] font-bold uppercase tracking-wider opacity-0 group-hover:opacity-60 hover:!opacity-100 transition ${t.cardText}`}>+ Add Detail</button>
                                        </div>
                                    </div>
                                </React.Fragment>
                            ))}

                            <div className="group/add w-full flex flex-col items-center mt-2 pb-10 cursor-pointer" onClick={addMainStep} data-html2canvas-ignore="true">
                                <div className={`w-0 h-0 border-x-[0.6em] border-x-transparent border-t-[0.8em] ${t.arrow} opacity-30 transition group-hover/add:opacity-100`}></div>
                                <div className={`mt-2 w-[1.5em] h-[1.5em] rounded-full border-2 flex items-center justify-center text-[1em] opacity-30 group-hover/add:opacity-100 transition scale-90 group-hover/add:scale-110 ${t.arrow} ${t.cardText}`}>+</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
